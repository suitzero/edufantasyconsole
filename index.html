<html>
    <meta charset="utf-8">
    <head>
    </head>
<style>
.grid-container {
  display: grid;
  grid-template-columns: auto auto auto;
  background-color: #2196F3;
  padding: 10px;
}

.grid-item {
  background-color: rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(0, 0, 0, 0.8);
  padding: 20px;
  font-size: 30px;
  text-align: center;
}

.grid-container2 {
  display: grid;
  grid-template-columns: auto auto auto;
  background-color: #77777;
  padding: 10px;
}

.instruction {
  text-align: left;
  font-size: 15px;
  width: 400px; 
}
</style>

    <body>
	    <div class="spinner" id='spinner'></div>
	    <div class="emscripten" id="status">Downloading...</div>
	    <div class="emscripten">
	      <progress value="0" max="100" id="progress" hidden=1></progress>
	    </div>

        <div>
		<div class="grid-container">
			<div class="tutorialpane grid-item">

				<div id="tuto1">
				<span>Tutorial 1</span>
<p class="instruction">
Welcome to world of programming! When the programmer newly introduce to world of programming.
We do certain ritual. It's like praying for good fortune. Type following text and run the code!
</p>
<pre class="instruction">

print "Hello World!"
</pre>
				</div>
				<div id="tuto2">
				<span>Tutorial 2</span>
<p class="instruction">
how about trying some arithmetic?
</p>
<pre class="instruction">
a = 1+1
b = 3*9
c = 13/2
print(a)
print(b)
print(c)
</pre>
				</div>
				<div id="tuto3">
				<span>Tutorial 3</span>
<p class="instruction">
do you know fibonacci number?
you can program it pretty easily with a few lines of code.
</p>
<pre class="instruction">
function fibonacci(n)
    if n<3 then
        return 1
    else
        return fibonacci(n-1) + fibonacci(n-2)
    end
end
print(fibonacci(10))
</pre>
				</div>
				<div id="tuto4">
				<span>Tutorial 4</span>
<p class="instruction">
Now we are going to test how display works in our fantasy console. 
I've prepared a speical function for that. Type this command to test!
</p>
<pre class="instruction">
colorful_render()
</pre>
				</div>
				<div id="tuto5">
				<span>Done!!</span>
<p class="instruction">
This is all I've prepared for this time.
we will build our first game with this education fantasy console, The Gorillas!
looking forward to meet you again!
</p>
<img src="assets/Gorillas_screenshot.png"/>
				</div>
				<button id="nextbutton" name="button" onclick="nexttutorial();">next</button>
			</div>
			<textarea id="edit" style="width: 400px; height: 480px;">

SCREEN_WIDTH=256
SCREEN_HEIGHT=256
numbuildings = 5
heights={}
colors={}
game={state=0}
player1={state=0,x=0,y=0,score=0,spr_num=3,width=32,height=22}
player2={state=0,x=0,y=0,score=0,spr_num=3,width=32,height=22}
banana={state=0,x=0,y=0,angle=0,velocity=0,spr_num=1,READY=0,Launch=1,EXPLODE=2,width=16,height=12}
tick=0
g=0.08
t=0
current_player = player1
hitplayer = 0
function init_game()
	for i=1,numbuildings do
		heights[i] = 100+math.random(100)
		colors[i] = math.random(20)
	end

	player1.x = 10/10
	player1.y = heights[1]-22
	player2.x = 220
	player2.y = heights[numbuildings]-22
	
	banana.angle = 0
	banana.velocity = 0
	if player1.score >= player2.score then
		current_player = player1
		banana.x = current_player.x
		player1.spr_num=5
	else
		current_player = player2
		banana.x = current_player.x+15
		player2.spr_num=4
	end
	banana.y = current_player.y-10
	hitplayer = 0
end

init_game()
bw =(SCREEN_WIDTH/numbuildings)

function draw_buildings()
    for i=1,numbuildings do 
	  fill_rect((i-1)*bw,heights[i],bw,SCREEN_HEIGHT-heights[i],172+colors[i],172+colors[i],160+colors[i])

	  for j=0,2 do
		for k=0,10 do
			fill_rect((i-1)*bw+5+j*15,heights[i]+5+k*15,10,10,222,222,222)
		end 
	  end
    end
end

ex=-1
ey=-1
function update_banana()
	if banana.state == banana.Launch then
		banana.x = banana.x + (banana.velocity * math.cos(banana.angle))
		banana.y = banana.y - banana.velocity * math.sin(banana.angle) + g*t
		t=t+1
	end
	if banana.state == banana.EXPLODE then
		banana.spr_num = 2
		if ex == -1 and ey == -1 then
			ex = banana.x
			ey = banana.y
			t = 200
		end
		banana.x=ex-(t%10)/2
		banana.y=ey-(t%10)/2
		banana.width=16+t%10
		banana.height=12+t%10
		t=t+1
	end
	if t > 250 then
		ex=-1
		ey=-1
		banana.state = banana.READY
		banana.spr_num = 1
		banana.width=16
		banana.height=12
		t=0
		if hitplayer == 0 then
			if current_player == player2 then
				current_player = player1
				player1.spr_num=5
				player2.spr_num=3
				banana.x = current_player.x
			else
				current_player = player2
				player1.spr_num=3
				player2.spr_num=4
				banana.x = current_player.x+15
			end
		else
			if hitplayer == 2 then
				player1.score=player1.score+1
			else
				player2.score=player2.score+1
			end
			init_game()
		end

		banana.y = current_player.y-10
	end
	i = math.floor(banana.x/bw)+1
	if banana.y > heights[i] then
		banana.state = banana.EXPLODE
	end
	if banana.state ~= banana.EXPLODE then
		if banana.y > player1.y and math.abs(banana.x-player1.x)<3 then
			banana.state = banana.EXPLODE
			--player2.score=player2.score+1
			player2.spr_num=6
			hitplayer=1
		end
		if banana.y > player2.y and math.abs(banana.x-player2.x)<3 then
			banana.state = banana.EXPLODE
			--player1.score=player1.score+1
			player1.spr_num=6
			hitplayer=2
		end
	end
	-- if banana.x < 0 or banana.y < 0 or banana.x > SCREEN_WIDTH or banana.y > SCREEN_HEIGHT then
		-- banana.state = banana.READY
		-- t=0
		-- banana.x = player1.x
		-- banana.y = player1.y
	-- end
	banana.angle = math.min(math.max(banana.angle,0),3.14)
	banana.velocity = math.min(math.max(banana.velocity,0),7)
end

function draw_banana()
	spr(banana.spr_num,banana.x,banana.y,banana.width,banana.height)
end

function _draw()
	fill_rect(0,0,256,256,153,217,234)
	draw_buildings()	
	tick=tick+1
	spr(player1.spr_num,player1.x,player1.y,player1.width,player1.height)
	spr(player2.spr_num,player2.x,player2.y,player2.width,player2.height)
	spr(7,125,10,32,32)
	draw_banana()
	write_text("Player1",3,3,48,8)
	write_text("Player2",205,3,48,8)
	write_text(tostring(player1.score)..">Score<"..tostring(player2.score),90,235,70,16)
	if game.state == 1 then
		if player1.score > player2.score then
			write_text("PLAYER1 WIN",55,100,140,40)
		else
			write_text("PLAYER2 WIN",55,100,150,40)
		end
	else
		if current_player == player1 then
			write_text("Angle:"..tostring(banana.angle),3,14,40,8)
			write_text("Velocity:"..tostring(banana.velocity),3,25,55,8)
		else
			write_text("Angle:"..tostring(banana.angle),200,14,40,8)
			write_text("Velocity:"..tostring(banana.velocity),200,25,55,8)		
		end
	end
	
end

function _update()
	if game.state == 0 then
		if btn(0) then banana.angle=banana.angle+0.01 end
		if btn(1) then banana.angle=banana.angle-0.01 end
		if btn(2) then banana.velocity=banana.velocity+0.1 end
		if btn(3) then banana.velocity=banana.velocity-0.1 end
		if btn(4) and banana.state == banana.READY then 
			banana.state = banana.Launch 
		end
		update_banana()
	end
	if player1.score + player2.score >= 3 and game.state == 0 then
		game.state = 1
	end
end


            </textarea>
			<button id="runcode" name="button" onclick="text_changed();">run code</button>
			<button id="cancelrun" name="button" onclick="cancel_run();">cancel run</button>
		</div>
		<div class="grid-container2">
			<div id="result" class="grid-item" style="width: 300px; float: right">
				<div class="emscripten_border">
				<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
				</div>
			</div>
			<div class="grid-item">
			    <textarea id="output" rows="17" style="width: 500px"></textarea>
			</div>
		</div>
	</div>
    </div>

    <script type="text/javascript" src="jquery-3.4.1.min.js"></script>
    <script type='text/javascript'>
        var tuto_status = 0

              $("#cancelrun").hide();
        function nexttutorial()
        {
            var total_page=5
            ++tuto_status;
            for(var i=1; i<=total_page;++i)
                $('#tuto'+i).hide();
            $('#tuto'+tuto_status).show();
			if( tuto_status == total_page )
			{
				$('#nextbutton').hide();	
			}
        }
        nexttutorial();
	    $("#edit").keydown(function(e) {
		        if(e.keyCode === 9) { // tab was pressed
				        // get caret position/selection
				        var start = this.selectionStart;
				        var end = this.selectionEnd;

				        var $this = $(this);
				        var value = $this.val();

				        // set textarea value to: text before caret + tab + text after caret
				        $this.val(value.substring(0, start)
						                    + "\t"
						                    + value.substring(end));

				        // put caret at right position again (add one for the tab)
				        this.selectionStart = this.selectionEnd = start + 1;

				        // prevent the focus lose
				        e.preventDefault();
				    }
	    });

      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var spinnerElement = document.getElementById('spinner');

      var Module = {
        preRun: [],
        postRun: [],
        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            // These replacements are necessary if you render to raw HTML
            //text = text.replace(/&/g, "&amp;");
            //text = text.replace(/</g, "&lt;");
            //text = text.replace(/>/g, "&gt;");
            //text = text.replace('\n', '<br>', 'g');
            console.log(text);
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          console.error(text);
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.last.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return; // if this is a progress update, skip it if too soon
          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.style.display = 'none';
          }
          statusElement.innerHTML = text;
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

            function text_changed() {
			  input = document.getElementById("edit").value;
              $("#edit").prop( "disabled", true );
              $("#cancelrun").show();
              $("#runcode").hide();
                        Module.ccall("run_lua", 'number', ['string'], [input]);
           }
            function cancel_run() {
			  input = document.getElementById("edit").value;
              $("#edit").prop( "disabled", false );
              $("#cancelrun").hide();
              $("#runcode").show();
                        Module.ccall("cancel_run", 'number', ['string'], [input]);
           }
    </script>
    <script async type="text/javascript" src="main.js"></script>
    </body>
</html>
